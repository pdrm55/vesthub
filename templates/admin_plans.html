{% extends 'admin_layout.html' %}

{% block title %}Manage Investment Plans{% endblock %}

{% block content %}
<h1 class="h2 fw-bold mb-4">Investment Plans Management</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="row g-4">
    <!-- Create New Plan -->
    <div class="col-lg-4">
        <div class="card shadow-sm rounded-4 sticky-top" style="top: 20px; z-index: 1;">
            <div class="card-header bg-dark-subtle p-3">
                <h5 class="fw-bold mb-0"><i class="bi bi-plus-circle me-2"></i>Create New Plan</h5>
            </div>
            <div class="card-body p-4">
                <form method="POST" action="{{ url_for('admin.plans') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label class="form-label">Plan Name</label>
                        <input type="text" class="form-control" name="name" placeholder="e.g. Gold Plus" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Duration (Months)</label>
                        <input type="number" class="form-control" name="duration" placeholder="12" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Annual Return (APY %)</label>
                        <input type="number" class="form-control" name="apy" step="0.1" placeholder="15.0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Risk Level Requirement</label>
                        <select class="form-select" name="risk">
                            <option value="low">Low (Conservative)</option>
                            <option value="medium">Medium (Balanced)</option>
                            <option value="high">High (Aggressive)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Create Plan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- List Existing Plans -->
    <div class="col-lg-8">
        <div class="card shadow-sm rounded-4">
            <div class="card-header bg-dark-subtle p-3">
                <h5 class="fw-bold mb-0">Existing Plans</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-striped mb-0 align-middle">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Dur.</th>
                                <th>APY</th>
                                <th>Risk</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for plan in plans %}
                            <tr>
                                <td class="fw-bold">{{ plan.name }}</td>
                                <td>{{ plan.duration_months }} Mo</td>
                                <td class="text-success">{{ plan.annual_return_rate }}%</td>
                                <td>
                                    {% if plan.risk_level == 'low' %}
                                        <span class="badge bg-info-subtle text-info-emphasis">Low</span>
                                    {% elif plan.risk_level == 'medium' %}
                                        <span class="badge bg-warning-subtle text-warning-emphasis">Medium</span>
                                    {% else %}
                                        <span class="badge bg-danger-subtle text-danger-emphasis">High</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if plan.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <!-- Edit Button -->
                                    <button type="button" class="btn btn-sm btn-outline-light me-1" 
                                            data-bs-toggle="modal" data-bs-target="#editPlanModal{{ plan.id }}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    
                                    <!-- Deactivate Button -->
                                    <form action="{{ url_for('admin.deactivate_plan', plan_id=plan.id) }}" method="POST" class="d-inline">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-sm btn-outline-warning me-1" title="Toggle Status">
                                            <i class="bi bi-power"></i>
                                        </button>
                                    </form>

                                    <!-- Delete Button (Hard Delete) -->
                                    <form action="{{ url_for('admin.delete_plan', plan_id=plan.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure? This cannot be undone.');">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Permanently">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>

                            <!-- Edit Modal for this Plan -->
                            <div class="modal fade" id="editPlanModal{{ plan.id }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content bg-dark text-white">
                                        <div class="modal-header border-secondary">
                                            <h5 class="modal-title">Edit Plan: {{ plan.name }}</h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <form method="POST" action="{{ url_for('admin.edit_plan', plan_id=plan.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <div class="modal-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Plan Name</label>
                                                    <input type="text" class="form-control" name="name" value="{{ plan.name }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Duration (Months)</label>
                                                    <input type="number" class="form-control" name="duration" value="{{ plan.duration_months }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">APY (%)</label>
                                                    <input type="number" class="form-control" name="apy" step="0.1" value="{{ plan.annual_return_rate }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Risk Level</label>
                                                    <select class="form-select" name="risk">
                                                        <option value="low" {% if plan.risk_level=='low' %}selected{% endif %}>Low</option>
                                                        <option value="medium" {% if plan.risk_level=='medium' %}selected{% endif %}>Medium</option>
                                                        <option value="high" {% if plan.risk_level=='high' %}selected{% endif %}>High</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Description</label>
                                                    <textarea class="form-control" name="description" rows="2">{{ plan.description }}</textarea>
                                                </div>
                                            </div>
                                            <div class="modal-footer border-secondary">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <tr><td colspan="6" class="text-center py-3">No plans found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}