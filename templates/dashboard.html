{% extends 'dashboard_layout.html' %}

{% block title %}Client Dashboard{% endblock %}

{% block content %}
<h1 class="h2 fw-bold mb-4">Welcome Back, {{ user.first_name }}!</h1>

<!-- Stats Row -->
<div class="row g-4 mb-4">
    <div class="col-md-6 col-xl-3">
        <div class="card shadow-sm rounded-4 h-100">
            <div class="card-body">
                <h6 class="text-body-secondary mb-1">Total Invested</h6>
                <h4 class="fw-bold mb-0">${{ "{:,.2f}".format(total_invested) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card shadow-sm rounded-4 h-100">
            <div class="card-body">
                <h6 class="text-body-secondary mb-1">Available Profit</h6>
                <h4 class="fw-bold text-success mb-0">${{ "{:,.2f}".format(total_profit) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card shadow-sm rounded-4 h-100">
            <div class="card-body">
                <h6 class="text-body-secondary mb-1">Referrals</h6>
                <h4 class="fw-bold mb-0">{{ referral_count }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card shadow-sm rounded-4 h-100">
            <div class="card-body">
                <h6 class="text-body-secondary mb-1">Referral Bonus</h6>
                <h4 class="fw-bold text-warning mb-0">${{ "{:,.2f}".format(referral_earnings) }}</h4>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card shadow-sm rounded-4 h-100">
            <div class="card-header bg-dark-subtle p-3"><h5 class="fw-bold mb-0">Portfolio Growth</h5></div>
            <div class="card-body">
                <canvas id="growthChart" style="height: 300px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow-sm rounded-4 h-100">
            <div class="card-header bg-dark-subtle p-3"><h5 class="fw-bold mb-0">Asset Allocation</h5></div>
            <div class="card-body">
                <canvas id="assetChart" style="height: 250px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Referral Link Section -->
<div class="card shadow-sm rounded-4 mb-4 bg-dark-subtle border-0">
    <div class="card-body p-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h5 class="fw-bold text-white"><i class="bi bi-share-fill me-2"></i>Invite Friends & Earn</h5>
                <p class="text-body-secondary mb-0">Share your unique code: <strong>{{ user.referral_code }}</strong></p>
            </div>
            <div class="col-md-4 mt-3 mt-md-0 text-end">
                <div class="input-group">
                    <input type="text" class="form-control fw-bold text-center" value="{{ request.host_url }}?ref={{ user.referral_code }}" readonly>
                    <button class="btn btn-primary" onclick="navigator.clipboard.writeText('{{ request.host_url }}?ref={{ user.referral_code }}')">
                        <i class="bi bi-clipboard"></i> Copy Link
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Investments Table -->
<div class="row g-4">
    <div class="col-lg-8">
        <div class="card shadow-sm rounded-4 h-100">
            <div class="card-header bg-dark-subtle p-3"><h5 class="fw-bold mb-0">My Active Investments</h5></div>
            <div class="card-body p-4">
                {% if active_investments %}
                    {% for inv in active_investments %}
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h3 class="fw-bold text-primary mb-1">{{ inv.plan.name }} (#{{ inv.id }})</h3>
                            <p class="text-body-secondary">Amount: ${{ "{:,.2f}".format(inv.amount) }}</p>
                            {% if inv.status == 'pending_payment' %}
                                <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill">Pending Payment</span>
                                <a href="{{ url_for('user.investment_pending', investment_id=inv.id) }}" class="btn btn-sm btn-outline-warning ms-2">Complete Payment</a>
                            {% else %}
                                <span class="badge bg-success-subtle text-success-emphasis rounded-pill">Active</span>
                            {% endif %}
                        </div>
                    </div>
                    <hr>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <p class="text-body-secondary">You have no active investments yet.</p>
                        <a href="{{ url_for('user.invest_plans') }}" class="btn btn-primary">Start Investing</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow-sm rounded-4 mb-4">
            <div class="card-body p-4 text-center">
                <i class="bi bi-cash-coin fs-1 text-primary mb-3"></i>
                <h5 class="fw-bold">Request Withdrawal</h5>
                {% if user.kyc_status == 'verified' %}
                    <a href="{{ url_for('user.withdrawal') }}" class="btn btn-primary w-100">Manage Withdrawals</a>
                {% else %}
                    <p class="text-warning small mb-2"><i class="bi bi-lock-fill"></i> KYC Required</p>
                    <a href="{{ url_for('user.settings') }}" class="btn btn-outline-warning w-100">Verify Identity</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Function to render charts
    function renderCharts(data) {
        // Asset Allocation (Doughnut)
        const ctxAsset = document.getElementById('assetChart');
        if (ctxAsset) {
            new Chart(ctxAsset, {
                type: 'doughnut',
                data: {
                    labels: ['Invested', 'Profit', 'Referral'],
                    datasets: [{
                        data: [data.assets.invested, data.assets.profit, data.assets.referral],
                        backgroundColor: ['#0d6efd', '#198754', '#ffc107'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        // Growth (Line)
        const ctxGrowth = document.getElementById('growthChart');
        if (ctxGrowth) {
            new Chart(ctxGrowth, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Total Value',
                        data: [1000, 1050, 1120, 1200], // Mock trend for demo
                        borderColor: '#00b0f0',
                        tension: 0.4
                    }]
                },
                options: { responsive: true }
            });
        }
    }

    // Mock Data for Fallback (Preview Mode)
    const mockData = {
        assets: {
            invested: 5000,
            profit: 1200,
            referral: 350
        }
    };

    // Attempt to fetch data, fall back to mock if API fails
    try {
        fetch('/api/chart/user-data')
        .then(res => {
            if (!res.ok) throw new Error("API unreachable");
            return res.json();
        })
        .then(data => renderCharts(data))
        .catch(err => {
            console.warn("Backend API not reachable (likely preview mode). Using mock data.", err);
            renderCharts(mockData);
        });
    } catch (e) {
        console.warn("Fetch error. Using mock data.", e);
        renderCharts(mockData);
    }
</script>
{% endblock %}